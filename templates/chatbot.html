<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIANT - Gigapixel Image Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --background-color: #f8fafc;
            --chat-bg: #ffffff;
            --user-msg-bg: #2563eb;
            --ai-msg-bg: #f1f5f9;
            --border-color: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: var(--chat-bg);
            border-right: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .image-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .image-item {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .image-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .image-item.selected {
            border-color: var(--primary-color);
            background: #f0f9ff;
        }

        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .image-info {
            flex: 1;
            min-width: 0;
        }

        .image-info h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .image-info p {
            margin: 0;
            font-size: 12px;
            color: #6b7280;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: var(--chat-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: #1f2937;
        }

        .chat-controls {
            display: flex;
            gap: 12px;
        }

        .btn-chat-control {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-chat-control:hover {
            background: var(--background-color);
            color: var(--primary-color);
        }



        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--background-color);
            max-height: calc(100vh - 200px); /* Ensure proper height calculation */
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.ai {
            justify-content: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: var(--user-msg-bg);
            color: white;
        }

        .ai .message-avatar {
            background: var(--ai-msg-bg);
            color: var(--secondary-color);
        }

        .message-content {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 18px;
            position: relative;
        }

        .user .message-content {
            background: var(--user-msg-bg);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai .message-content {
            background: var(--chat-bg);
            color: #1f2937;
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .iteration-step {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        /* Ensure images in iteration steps are properly sized */
        .message-content .iteration-step img,
        .analysis-container .iteration-step img {
            width: 60px !important;
            height: 60px !important;
            max-width: 60px !important;
            max-height: 60px !important;
        }

        .iteration-thumbnail {
            width: 60px !important;
            height: 60px !important;
            max-width: 60px !important;
            max-height: 60px !important;
            min-width: 60px !important;
            min-height: 60px !important;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
            object-fit: cover;
            flex-shrink: 0;
        }

        .iteration-thumbnail:hover {
            transform: scale(1.05);
        }

        .iteration-icon-placeholder {
            width: 60px !important;
            height: 60px !important;
            max-width: 60px !important;
            max-height: 60px !important;
            min-width: 60px !important;
            min-height: 60px !important;
            border-radius: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            flex-shrink: 0;
        }

        .iteration-info {
            flex: 1;
            min-width: 0;
        }

        .iteration-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .iteration-coords {
            color: #6b7280;
            font-size: 12px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }

        .iteration-reasoning {
            color: #374151;
            font-size: 13px;
            margin-top: 6px;
            line-height: 1.4;
            padding: 8px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 3px solid #2563eb;
        }

        .note-step {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 8px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .note-icon-placeholder {
            width: 60px !important;
            height: 60px !important;
            max-width: 60px !important;
            max-height: 60px !important;
            min-width: 60px !important;
            min-height: 60px !important;
            border-radius: 6px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            flex-shrink: 0;
        }

        .note-info {
            flex: 1;
            min-width: 0;
        }

        .note-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 4px;
        }

        .note-content {
            color: #78350f;
            font-size: 13px;
            line-height: 1.4;
        }



        .chat-input-area {
            background: var(--chat-bg);
            border-top: 1px solid var(--border-color);
            padding: 16px 24px;
        }

        .input-wrapper {
            position: relative;
            max-width: 100%;
        }

        .chat-input {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 50px 12px 16px;
            font-size: 16px;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary-color);
        }

        .send-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .send-button:hover {
            background: #1d4ed8;
        }

        .send-button:disabled {
            background: var(--secondary-color);
            cursor: not-allowed;
        }

        .final-analysis {
            margin: 12px 0;
        }

        .analysis-metadata {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }

        .analysis-container {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
        }

        .analysis-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0ea5e9;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .analysis-steps {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 4px;
        }

        /* Custom scrollbar for analysis steps */
        .analysis-steps::-webkit-scrollbar {
            width: 6px;
        }

        .analysis-steps::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .analysis-steps::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .analysis-steps::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Setup form styles */
        .form-select, .form-control {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 12px;
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            padding: 12px 24px;
        }

        /* Modal styles */
        .modal-dialog {
            max-width: 90%;
        }

        .modal-body img {
            width: 100%;
            height: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 2px solid var(--border-color);
            }
            
            .image-list {
                display: flex;
                overflow-x: auto;
                padding: 8px;
            }
            
            .image-item {
                min-width: 180px;
                margin-right: 12px;
                margin-bottom: 0;
            }
            
            .image-preview {
                width: 50px;
                height: 50px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .iteration-thumbnail {
                width: 50px !important;
                height: 50px !important;
                max-width: 50px !important;
                max-height: 50px !important;
                min-width: 50px !important;
                min-height: 50px !important;
            }

            .iteration-icon-placeholder {
                width: 50px !important;
                height: 50px !important;
                max-width: 50px !important;
                max-height: 50px !important;
                min-width: 50px !important;
                min-height: 50px !important;
                font-size: 20px;
            }

            .analysis-container {
                padding: 10px;
            }

            .analysis-steps {
                max-height: 250px;
            }

            .analysis-container .iteration-step img {
                width: 50px !important;
                height: 50px !important;
                max-width: 50px !important;
                max-height: 50px !important;
                min-width: 50px !important;
                min-height: 50px !important;
            }

            .iteration-reasoning {
                font-size: 12px;
                padding: 6px;
                margin-top: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-microscope me-2"></i>
                WSI Images
            </div>
            
            <div class="image-list" id="imageList">
                {% for wsi in wsi_images %}
                <div class="image-item" data-path="{{ wsi.path }}" data-name="{{ wsi.name }}" 
                     data-dimensions="{{ wsi.dimensions[0] }}x{{ wsi.dimensions[1] }}">
                    <img src="{{ wsi.preview }}" alt="{{ wsi.name }}" class="image-preview">
                    <div class="image-info">
                        <h4>{{ wsi.name }}</h4>
                        <p>{{ "{:,}".format(wsi.dimensions[0]) }} Ã— {{ "{:,}".format(wsi.dimensions[1]) }} pixels</p>
                    </div>
                </div>
                {% endfor %}
                
                {% if not wsi_images %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    No WSI files found. Please add WSI files to the project directory.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <!-- Header -->
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-robot"></i>
                    <span>GIANT</span>
                    <span id="slideInfo" class="badge bg-secondary" style="display: none;"></span>
                </div>
                <div class="chat-controls">
                    <button id="resetBtn" class="btn-chat-control" style="display: none;">
                        <i class="fas fa-refresh me-1"></i>Reset
                    </button>
                    <button id="newSessionBtn" class="btn-chat-control" onclick="location.reload()">
                        <i class="fas fa-plus me-1"></i>New Session
                    </button>
                </div>
            </div>

            <!-- Welcome Message -->
            <div id="welcomeMessage" class="chat-messages" style="display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center; color: #6b7280;">
                    <i class="fas fa-arrow-left me-2"></i>
                    Select a whole-slide image from the sidebar to begin analysis
                </div>
            </div>

            <!-- Chat Phase -->
            <div id="chatPhase" style="display: none; flex: 1; flex-direction: column;">
                <!-- Messages -->
                <div class="chat-messages" id="messagesContainer">
                    <!-- Messages will be inserted here -->
                </div>

                <!-- Input Area -->
                <div class="chat-input-area">
                    <div class="input-wrapper">
                        <textarea id="messageInput" class="chat-input" 
                                  placeholder="Ask a question about the slide..."
                                  rows="1"></textarea>
                        <button id="sendBtn" class="send-button" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalTitle">Image Detail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="Full size image">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let socket;
        let conversationId = null;
        let isAnalyzing = false;
        let currentAnalysisMessage = null;
        let analysisSteps = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            setupEventListeners();
            adjustTextareaHeight();
        });

        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('conversation_started', function(data) {
                console.log('Conversation started event received:', data);
                conversationId = data.conversation_id;
                const dimensions = data.slide_dimensions;
                
                // Extract filename from path for display
                const fileName = data.wsi_file.split('/').pop();
                document.getElementById('slideInfo').textContent = 
                    `${fileName} (${dimensions.width.toLocaleString()} Ã— ${dimensions.height.toLocaleString()})`;
                document.getElementById('slideInfo').style.display = 'inline-block';
                
                // Switch to chat phase
                console.log('Switching to chat phase');
                document.getElementById('welcomeMessage').style.display = 'none';
                const chatPhase = document.getElementById('chatPhase');
                chatPhase.style.display = 'flex';
                document.getElementById('resetBtn').style.display = 'inline-block';
                
                // Clear any existing messages
                document.getElementById('messagesContainer').innerHTML = '';
                
                // Add welcome message
                addMessage('ai', 'I\'m ready to analyze the slide. You can ask me to examine specific areas, look for particular features, or start with a general examination. What would you like me to do?');
                
                // Enable input and focus
                enableInput();
            });

            socket.on('user_message', function(data) {
                // User message already shown when sent
            });

            socket.on('ai_thinking', function(data) {
                // No longer need thinking indicator since each step shows immediately
            });

            socket.on('iteration_update', function(data) {
                updateCurrentAnalysis(data);
            });

            socket.on('note_update', function(data) {
                updateCurrentAnalysisWithNote(data);
            });

            socket.on('final_analysis', function(data) {
                finishAnalysis(data);
            });

            socket.on('conversation_reset', function(data) {
                clearMessages();
                addMessage('ai', data.message);
                isAnalyzing = false;
                enableInput();
                currentAnalysisMessage = null;
                analysisSteps = [];
            });

            socket.on('error', function(data) {
                console.error('Socket error:', data);
                addMessage('ai', `Error: ${data.message}`, 'error');
                isAnalyzing = false;
                enableInput();
                currentAnalysisMessage = null;
                analysisSteps = [];
            });
        }

        function setupEventListeners() {
            // Image selection from sidebar
            const imageItems = document.querySelectorAll('.image-item');
            console.log('Found', imageItems.length, 'image items');
            
            imageItems.forEach(item => {
                item.addEventListener('click', function() {
                    console.log('Image item clicked');
                    
                    // Remove selection from other items
                    document.querySelectorAll('.image-item').forEach(i => i.classList.remove('selected'));
                    
                    // Select this item
                    this.classList.add('selected');
                    
                    const wsiPath = this.getAttribute('data-path');
                    const wsiName = this.getAttribute('data-name');
                    const dimensions = this.getAttribute('data-dimensions');
                    
                    console.log('Starting conversation with:', wsiPath);
                    console.log('Socket connected:', socket && socket.connected);
                    
                    // Start conversation with selected image
                    socket.emit('start_conversation', { wsi_file: wsiPath });
                });
            });

            // Send message
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Reset conversation
            document.getElementById('resetBtn').addEventListener('click', function() {
                if (conversationId) {
                    socket.emit('reset_conversation', { conversation_id: conversationId });
                }
            });

            // Auto-resize textarea and toggle send button
            document.getElementById('messageInput').addEventListener('input', function() {
                adjustTextareaHeight();
                updateSendButtonState();
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !conversationId || isAnalyzing) return;
            
            // Show user message
            addMessage('user', message);
            
            // Clear input
            messageInput.value = '';
            adjustTextareaHeight();
            updateSendButtonState();
            
            // Disable input during analysis
            isAnalyzing = true;
            disableInput();
            
            // Send to server
            socket.emit('send_message', {
                conversation_id: conversationId,
                message: message
            });
        }

        function addMessage(role, content, type = 'normal') {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = role === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (type === 'error') {
                messageContent.style.background = '#fee2e2';
                messageContent.style.color = '#dc2626';
                messageContent.style.borderColor = '#fecaca';
            }
            
            // If content contains HTML tags, render as HTML, otherwise treat as text
            if (content.includes('<')) {
                messageContent.innerHTML = content;
            } else {
                messageContent.innerHTML = content.replace(/\n/g, '<br>');
            }

            if (role === 'user') {
                messageDiv.appendChild(messageContent);
                messageDiv.appendChild(avatar);
            } else {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
            }

            messagesContainer.appendChild(messageDiv);
            
            // Improved scrolling
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 10);

            return messageDiv;
        }



        function updateCurrentAnalysis(data) {
            // Create analysis container if it doesn't exist
            if (!currentAnalysisMessage) {
                const analysisHtml = `
                    <div class="analysis-container">
                        <div class="analysis-header">
                            <i class="fas fa-microscope"></i>
                            <span>Analyzing slide...</span>
                        </div>
                        <div class="analysis-steps" id="analysisStepsContainer">
                        </div>
                    </div>
                `;
                currentAnalysisMessage = addMessage('ai', analysisHtml);
                analysisSteps = [];
            }

            let stepHtml;
            
            // Handle different iteration types
            if (data.iteration_type === 'log') {
                // Log iteration - no image, just observations and plans
                stepHtml = `
                    <div class="iteration-step">
                        <div class="iteration-icon-placeholder">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        
                        <div class="iteration-info">
                            <div class="iteration-title">
                                <i class="fas fa-pen me-1"></i>
                                Step ${data.step} - Log Entry
                            </div>
                            <div class="iteration-reasoning">
                                ${data.thought.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Zoom or overview iteration - has image
                const reasoningHtml = data.ai_reasoning ? `
                    <div class="iteration-reasoning">
                        <strong>AI Reasoning:</strong> ${data.ai_reasoning.replace(/\n/g, '<br>')}
                    </div>
                ` : '';
                
                // Build cost information HTML - handle both cost formats
                let costHtml = '';
                if (data.tokens && data.cost) {
                    // Handle token format (both 'input'/'output' and 'prompt'/'completion')
                    const inputTokens = data.tokens.input || data.tokens.prompt || 0;
                    const outputTokens = data.tokens.output || data.tokens.completion || 0;
                    const totalTokens = data.tokens.total || (inputTokens + outputTokens);
                    
                    // Handle cost format (dict or float)
                    let stepCost = 0;
                    let cumulativeCost = 0;
                    if (typeof data.cost === 'object') {
                        stepCost = data.cost.step || 0;
                        cumulativeCost = data.cost.cumulative || 0;
                    } else {
                        stepCost = data.cost || 0;
                    }
                    
                    if (totalTokens > 0 || stepCost > 0) {
                        costHtml = `
                            <div class="iteration-coords" style="margin-top: 4px; font-weight: 500;">
                                ðŸ’° ${totalTokens.toLocaleString()} tokens 
                                (${inputTokens.toLocaleString()} in / ${outputTokens.toLocaleString()} out)`;
                        
                        if (cumulativeCost > 0) {
                            costHtml += ` â€¢ $${stepCost.toFixed(4)} this step â€¢ $${cumulativeCost.toFixed(4)} cumulative`;
                        } else if (stepCost > 0) {
                            costHtml += ` â€¢ $${stepCost.toFixed(4)}`;
                        }
                        
                        costHtml += `
                            </div>
                        `;
                    }
                }
                
                stepHtml = `
                    <div class="iteration-step">
                        <img src="${data.image_url}" alt="Step ${data.step}" 
                             class="iteration-thumbnail" 
                             onclick="showImageModal('${data.image_url}', '${data.iteration_type === 'overview' ? 'Overview' : `Step ${data.step}`}')">
                        
                        <div class="iteration-info">
                            <div class="iteration-title">
                                <i class="fas fa-${data.iteration_type === 'overview' ? 'globe' : 'search-plus'} me-1"></i>
                                ${data.iteration_type === 'overview' ? 'Overview' : `Step ${data.step}`}
                            </div>
                            <div class="iteration-coords">
                                (${data.coordinates.x0}, ${data.coordinates.y0}) â€¢ ${data.coordinates.w} Ã— ${data.coordinates.h}px
                            </div>
                            ${costHtml}
                            ${reasoningHtml}
                        </div>
                    </div>
                `;
            }

            analysisSteps.push(stepHtml);
            
            // Update the analysis container with all steps
            const stepsContainer = currentAnalysisMessage.querySelector('.analysis-steps');
            if (stepsContainer) {
                stepsContainer.innerHTML = analysisSteps.join('');
                
                // Auto-scroll the steps container to show the latest step
                setTimeout(() => {
                    stepsContainer.scrollTop = stepsContainer.scrollHeight;
                }, 10);
            }

            // Scroll chat to bottom
            const messagesContainer = document.getElementById('messagesContainer');
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 10);
        }

        function updateCurrentAnalysisWithNote(data) {
            // Create analysis container if it doesn't exist
            if (!currentAnalysisMessage) {
                const analysisHtml = `
                    <div class="analysis-container">
                        <div class="analysis-header">
                            <i class="fas fa-microscope"></i>
                            <span>Analyzing slide...</span>
                        </div>
                        <div class="analysis-steps" id="analysisStepsContainer">
                        </div>
                    </div>
                `;
                currentAnalysisMessage = addMessage('ai', analysisHtml);
                analysisSteps = [];
            }

            // Create note step HTML
            const noteHtml = `
                <div class="note-step">
                    <div class="note-icon-placeholder">
                        <i class="fas fa-sticky-note"></i>
                    </div>
                    
                    <div class="note-info">
                        <div class="note-title">
                            <i class="fas fa-bookmark me-1"></i>
                            Step ${data.step} - Important Finding Noted
                        </div>
                        <div class="note-content">
                            ${data.observation.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>
            `;

            analysisSteps.push(noteHtml);
            
            // Update the analysis container with all steps
            const stepsContainer = currentAnalysisMessage.querySelector('.analysis-steps');
            if (stepsContainer) {
                stepsContainer.innerHTML = analysisSteps.join('');
                
                // Auto-scroll the steps container to show the latest step
                setTimeout(() => {
                    stepsContainer.scrollTop = stepsContainer.scrollHeight;
                }, 10);
            }

            // Scroll chat to bottom
            const messagesContainer = document.getElementById('messagesContainer');
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 10);
        }

        function finishAnalysis(data) {
            // Build metadata string with detailed token/cost breakdown
            let metadataHtml = `
                <strong>Analysis completed</strong><br>
                <strong>Iterations:</strong> ${data.metadata.total_iterations || 0}<br>
            `;
            
            // Add detailed token info if available - handle different formats
            if (data.metadata.tokens && typeof data.metadata.tokens === 'object') {
                const inputTokens = data.metadata.tokens.input || data.metadata.tokens.prompt || 0;
                const outputTokens = data.metadata.tokens.output || data.metadata.tokens.completion || 0;
                const totalTokens = data.metadata.tokens.total || (inputTokens + outputTokens);
                
                metadataHtml += `
                    <strong>Tokens:</strong> ${totalTokens.toLocaleString()} total 
                    (${inputTokens.toLocaleString()} input + ${outputTokens.toLocaleString()} output)<br>
                `;
            } else if (data.metadata.total_tokens) {
                metadataHtml += `<strong>Tokens:</strong> ${data.metadata.total_tokens.toLocaleString()}<br>`;
            } else {
                metadataHtml += `<strong>Tokens:</strong> N/A<br>`;
            }
            
            // Handle cost - might be undefined
            const totalCost = data.metadata.total_cost || 0;
            metadataHtml += `<strong>ðŸ’° Total Cost:</strong> $${totalCost.toFixed(4)}`;
            
            // Add notes count if present
            if (data.metadata.notes && data.metadata.notes.length > 0) {
                metadataHtml += `<br><strong>Notes:</strong> ${data.metadata.notes.length} finding(s) recorded`;
            }
            
            const finalHtml = `
                <div class="final-analysis">
                    ${data.analysis.replace(/\n/g, '<br>')}
                    <div class="analysis-metadata">
                        ${metadataHtml}
                    </div>
                </div>
            `;

            addMessage('ai', finalHtml);
            
            // Re-enable input for follow-up questions
            isAnalyzing = false;
            enableInput();
            currentAnalysisMessage = null;
            analysisSteps = [];
        }

        function clearMessages() {
            document.getElementById('messagesContainer').innerHTML = '';
        }

        function disableInput() {
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
        }

        function enableInput() {
            document.getElementById('messageInput').disabled = false;
            updateSendButtonState();
            document.getElementById('messageInput').focus();
        }

        function updateSendButtonState() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const hasText = messageInput.value.trim().length > 0;
            const canSend = conversationId && !isAnalyzing && hasText;
            sendBtn.disabled = !canSend;
        }

        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function showImageModal(imageSrc, title) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('imageModalTitle').textContent = title;
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }
         </script>
</body>
</html> 